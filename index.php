<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Le Pouvoir du Savoir – Livre Numérique</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="./image/covert.png">
  <meta name="description" content="Sur les traces de l’âme congolaise – Un roman semi-autobiographique puissant, voyage initiatique au cœur du Congo, traditions, spiritualité, réflexions sociales et politiques.">
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-XXXXXXXXXX'); // Remplacez G-XXXXXXXXXX par votre propre ID GA4
  </script>
  <link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,400|Merriweather:400,700|Lora:400,700&display=swap" rel="stylesheet">
</head>
<body>
  <header class="hero">
    <div style="position:absolute;top:20px;left:20px;z-index:10;">
      <span style="background:#27ae60;color:#fff;padding:8px 18px;border-radius:20px;font-weight:bold;font-size:1.1em;box-shadow:0 2px 8px rgba(39,174,96,0.15);letter-spacing:1px;">GRATUIT</span>
    </div>
    <div class="container">
      <img src="./image/covert.png" alt="Couverture du livre Sur les traces de l'âme congolaise" class="book-cover" style="background:#7c4a03; box-shadow:0 8px 32px rgba(124,74,3,0.25); border:3px solid #a86c1d;">
      <h1>Sur les traces de l'ame Congolaise</h1>
      <p class="slogan">Ouvrez un livre, debutez votre voyage.</p>
      <div class="summary-block">
        <h2>📘 À propos du livre</h2>
        <ul class="book-meta">
          <li><strong>Titre :</strong> Sur les traces de l’âme congolaise</li>
          <li><strong>Genre :</strong> Roman semi-autobiographique – Réflexion sociale, politique et spirituelle</li>
          <li><strong>Langue :</strong> Français</li>
          <li><strong>Auteur :</strong> NDOUMBA-MBOUBA Duvet Gema</li>
        </ul>
        <p class="summary">
          Sur les traces de l’âme congolaise est un roman semi-autobiographique puissant, inspiré de faits réels. Il retrace le voyage initiatique de deux jeunes allemands au cœur du Congo, guidés par un narrateur local, photographe de rue et témoin privilégié de son pays. À travers cinq chapitres intenses, les lecteurs sont plongés dans les mystères du Mayombe, les traditions congolaises vivantes, les contrastes sociaux du quotidien, mais aussi les rêves, les espoirs et les douleurs d’un peuple en quête d’avenir.<br><br>
          Entre spiritualité africaine, réflexions politiques, chocs interculturels et beautés invisibles, ce récit explore l’âme d’un pays méconnu, avec sincérité et profondeur. L’écriture immersive de l’auteur capte l’essence de l’Afrique contemporaine : une Afrique qui souffre, mais qui résiste, espère, et rayonne.
        </p>
      </div>
      <div class="download-buttons">
        <a href="./pdf/livre.pdf"" class="btn btn-primary" download="Sur_les_traces_de_l_ame_congolaise.pdf">Télécharger PDF</a>
        <a href="./pdf/livre.pdf" class="btn btn-secondary" download="Sur_les_traces_de_l_ame_congolaise.epub">Télécharger EPUB</a>
      </div>
      <div class="like-section">
        <button id="like-btn" class="like-btn">❤️ <span id="like-count">0</span></button>
      </div>
    </div>
  </header>

  <section class="testimonials">
    <div class="container">
      <h2>Ce que disent les lecteurs</h2>
      <div class="testimonial-list">
        <blockquote>
          « Un livre qui a changé ma façon de penser. À lire absolument ! »<br><span>— Sophie, Paris</span>
        </blockquote>
        <blockquote>
          « Inspirant, motivant, et très bien écrit. Je le recommande à tous mes amis. »<br><span>— Marc, Lyon</span>
        </blockquote>
        <blockquote>
          « Un guide précieux pour avancer dans la vie avec confiance. »<br><span>— Amina, Dakar</span>
        </blockquote>
      </div>
    </div>
  </section>

  <section class="about-author">
    <div class="container">
      <h2>À propos de l’auteur</h2>
      <div class="author-info">
        <img src=".//image/author.jpg" alt="Photo de l’auteur Duvet Gema Ndoumba-Mbouba" class="author-photo">
        <div>
          <h3>✍️ À propos de l’auteur</h3>
          <p><strong>Duvet Gema Ndoumba-Mbouba</strong> est un jeune écrivain congolais passionné de culture, d’art et d’humanisme. Titulaire d’une licence en mathématiques, il poursuit également des études en informatique, tout en cultivant un amour profond pour l’écriture et la photographie de rue.</p>
          <p>À travers ses œuvres, il cherche à raconter une Afrique authentique, sensible et moderne, loin des clichés, en mettant en lumière les voix invisibles, les traditions oubliées et les réalités vécues. <em>Sur les traces de l’âme congolaise</em> est son premier roman, fruit d’une quête personnelle et collective d’identité, de mémoire et d’avenir.</p>
          <p>Son style est marqué par la sincérité, l’observation fine du quotidien, et une volonté d’éveiller les consciences à travers la narration.</p>
          <div class="author-social">
            <a href="https://www.linkedin.com/in/duvet-gema-ndoumba-105a45231/" target="_blank" title="LinkedIn" class="social-link linkedin">
              <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-10h3v10zm-1.5-11.268c-.966 0-1.75-.784-1.75-1.75s.784-1.75 1.75-1.75 1.75.784 1.75 1.75-.784 1.75-1.75 1.75zm13.5 11.268h-3v-5.604c0-1.337-.025-3.063-1.868-3.063-1.868 0-2.154 1.459-2.154 2.967v5.7h-3v-10h2.881v1.367h.041c.401-.761 1.379-1.563 2.838-1.563 3.034 0 3.595 1.997 3.595 4.594v5.602z"/></svg>
            </a>
            <a href="https://www.facebook.com/duvet.gema" target="_blank" title="Facebook" class="social-link facebook">
              <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M22.675 0h-21.35c-.733 0-1.325.592-1.325 1.326v21.348c0 .733.592 1.326 1.325 1.326h11.495v-9.294h-3.128v-3.622h3.128v-2.671c0-3.1 1.893-4.788 4.659-4.788 1.325 0 2.463.099 2.797.143v3.24l-1.918.001c-1.504 0-1.797.715-1.797 1.763v2.312h3.587l-.467 3.622h-3.12v9.294h6.116c.729 0 1.321-.593 1.321-1.326v-21.349c0-.734-.592-1.326-1.325-1.326z"/></svg>
            </a>
            <a href="https://wa.me/242065922471" target="_blank" title="WhatsApp" class="social-link whatsapp">
              <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M20.52 3.478a11.826 11.826 0 0 0-16.72 0c-4.66 4.66-4.66 12.24 0 16.9a11.826 11.826 0 0 0 16.72 0c4.66-4.66 4.66-12.24 0-16.9zm-8.52 17.522c-1.7 0-3.36-.44-4.8-1.28l-5.12 1.36 1.36-5.12c-.84-1.44-1.28-3.1-1.28-4.8 0-5.06 4.12-9.18 9.18-9.18s9.18 4.12 9.18 9.18-4.12 9.18-9.18 9.18zm5.44-7.18c-.08-.14-.3-.22-.62-.38-.32-.16-1.88-.92-2.18-1.02-.3-.1-.52-.14-.74.14-.22.28-.86 1.02-1.06 1.24-.2.22-.38.24-.7.08-.32-.16-1.36-.5-2.6-1.6-.96-.86-1.6-1.92-1.78-2.24-.18-.32-.02-.5.14-.66.14-.14.32-.36.48-.54.16-.18.22-.32.34-.54.12-.22.06-.42-.02-.6-.08-.18-.74-1.78-1.02-2.44-.28-.66-.56-.56-.74-.56-.18 0-.4-.02-.62-.02-.22 0-.56.08-.86.38-.3.3-1.14 1.12-1.14 2.74 0 1.62 1.16 3.18 1.32 3.4.16.22 2.28 3.48 5.54 4.74.78.32 1.38.5 1.86.64.78.24 1.5.2 2.06.12.62-.1 1.88-.76 2.14-1.5.26-.74.26-1.38.18-1.5z"/></svg>
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SECTION QUIZ -->
  <section id="quiz-section">
    <div class="container">
      <h2>Quiz interactif</h2>
      <div id="quiz-progress-bar" style="height:18px;width:100%;background:#23263a;border-radius:10px;margin-bottom:18px;overflow:hidden;box-shadow:0 1px 6px rgba(39,174,96,0.08);">
        <div id="quiz-progress-inner" style="height:100%;width:0%;background:linear-gradient(90deg,#27ae60 60%,#e6b87a 100%);border-radius:10px;transition:width 0.4s;"></div>
      </div>
      <div id="quiz-container"></div>
    </div>
  </section>

  <!-- MODAL CONNEXION UTILISATEUR -->
  <div id="login-modal" style="display:flex;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(24,28,43,0.95);z-index:9999;align-items:center;justify-content:center;">
    <form id="login-form" style="background:#23263a;padding:2em 2em 1em 2em;border-radius:18px;max-width:350px;margin:10vh auto;">
      <h2>Connexion</h2>
      <input type="text" id="login-prenom" placeholder="Votre prénom" required style="width:100%;margin-bottom:1em;">
      <input type="text" id="login-numero" placeholder="Votre numéro" required style="width:100%;margin-bottom:1em;">
      <button type="submit" class="btn btn-primary" style="width:100%;">Se connecter</button>
      <div id="login-error" style="color:#e74c3c;margin-top:1em;"></div>
    </form>
  </div>
  <!-- BOUTON DECONNEXION -->
  <button id="logout-btn" style="display:none;position:fixed;top:18px;right:18px;z-index:10000;background:#751a5e;color:#fff;border:none;padding:10px 22px;border-radius:22px;font-size:1em;font-weight:bold;box-shadow:0 2px 8px rgba(24,28,43,0.12);cursor:pointer;">Déconnexion</button>

  <section class="comments">
    <div class="container">
      <h2>Laissez un commentaire</h2>
      <form id="comment-form">
        <textarea id="message" name="message" placeholder="Votre avis..." required></textarea>
        <button type="submit" class="btn btn-primary">Envoyer</button>
      </form>
      <div id="comment-success" class="success-message"></div>
      <div id="comments-list"></div>
      <div id="comments-pagination" style="text-align:center;margin-top:10px;"></div>
    </div>
  </section>

  <section class="newsletter">
    <div class="container">
      <h2>Abonnez-vous à la newsletter</h2>
      <form id="newsletter-form">
        <input type="email" id="newsletter-email" name="email" placeholder="Votre email">
        <button type="submit" class="btn btn-secondary">S’abonner</button>
      </form>
      <div id="newsletter-success" class="success-message"></div>
    </div>
  </section>

  <section class="contact">
    <div class="container">
      <h2>Contactez l’auteur</h2>
      <form id="contact-form">
        <input type="text" id="contact-nom" name="nom" placeholder="Votre nom" required>
        <input type="email" id="contact-email" name="email" placeholder="Votre email" required>
        <textarea id="contact-message" name="message" placeholder="Votre message" required></textarea>
        <button type="submit" class="btn btn-primary">Envoyer</button>
      </form>
      <div id="contact-success" class="success-message"></div>
    </div>
  </section>

  <footer>
    <div class="container">
      <p>&copy; 2024 DUVET GEMA NDOUMBA-MBOUBA. Tous droits réservés.</p>
      <p><a href="mentions-legales.php" style="color:#a86c1d;text-decoration:underline;">Mentions légales & Politique de confidentialité</a></p>
    </div>
  </footer>

  <script>
    // Charger et afficher les commentaires depuis le backend PHP
    let allComments = [];
    let currentPage = 1;
    const commentsPerPage = 5;
    function renderCommentsPage(page) {
      const commentsList = document.getElementById('comments-list');
      commentsList.innerHTML = '';
      const start = (page-1)*commentsPerPage;
      const end = start + commentsPerPage;
      allComments.slice(start, end).forEach(comment => {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'comment';
        commentDiv.innerHTML = `<strong>${comment.prenom}</strong> : <span>${comment.message}</span>`;
        commentsList.appendChild(commentDiv);
      });
      // Pagination controls
      const pagDiv = document.getElementById('comments-pagination');
      pagDiv.innerHTML = '';
      const totalPages = Math.ceil(allComments.length/commentsPerPage);
      if(totalPages > 1) {
        if(page > 1) {
          const prevBtn = document.createElement('button');
          prevBtn.textContent = 'Précédent';
          prevBtn.className = 'btn btn-secondary';
          prevBtn.onclick = () => { currentPage--; renderCommentsPage(currentPage); };
          pagDiv.appendChild(prevBtn);
        }
        pagDiv.appendChild(document.createTextNode(` Page ${page} / ${totalPages} `));
        if(page < totalPages) {
          const nextBtn = document.createElement('button');
          nextBtn.textContent = 'Suivant';
          nextBtn.className = 'btn btn-secondary';
          nextBtn.onclick = () => { currentPage++; renderCommentsPage(currentPage); };
          pagDiv.appendChild(nextBtn);
        }
      }
    }
    function loadComments() {
      fetch('get_comments.php')
        .then(res => res.json())
        .then(data => {
          allComments = data;
          currentPage = 1;
          renderCommentsPage(currentPage);
        });
    }
    loadComments();

    // Ajouter un commentaire via PHP (AJAX)
    document.getElementById('comment-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const message = document.getElementById('message').value;
      if(message) {
        const formData = new FormData();
        formData.append('message', message);
        fetch('add_comment.php', {
          method: 'POST',
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          if(data.success) {
            loadComments();
            document.getElementById('comment-form').reset();
            document.getElementById('comment-success').textContent = 'Merci pour votre commentaire !';
            document.getElementById('comment-success').classList.add('visible');
            setTimeout(() => {
              document.getElementById('comment-success').classList.remove('visible');
            }, 3500);
          } else {
            alert('Erreur : ' + (data.error || 'Impossible d\'ajouter le commentaire.'));
          }
        });
      }
    });

    // Connexion utilisateur
    function isLoggedIn() {
      return localStorage.getItem('user_id') && localStorage.getItem('prenom');
    }
    function showLoginModal() {
      document.getElementById('login-modal').style.display = 'flex';
      document.getElementById('logout-btn').style.display = 'none';
    }
    function hideLoginModal() {
      document.getElementById('login-modal').style.display = 'none';
      document.getElementById('logout-btn').style.display = '';
    }
    if (!isLoggedIn()) {
      showLoginModal();
      // Bloque les autres interactions
      document.getElementById('comment-form').style.display = 'none';
      document.getElementById('quiz-section').style.display = 'none';
      document.getElementById('logout-btn').style.display = 'none';
    } else {
      hideLoginModal();
      document.getElementById('comment-form').style.display = '';
      document.getElementById('quiz-section').style.display = '';
      document.getElementById('logout-btn').style.display = '';
    }
    document.getElementById('login-form').addEventListener('submit', function(e){
      e.preventDefault();
      const prenom = document.getElementById('login-prenom').value.trim();
      const numero = document.getElementById('login-numero').value.trim();
      fetch('login.php', {
        method: 'POST',
        body: new URLSearchParams({prenom, numero})
      })
      .then(res => res.json())
      .then(data => {
        if(data.success){
          localStorage.setItem('prenom', data.prenom);
          localStorage.setItem('user_id', data.user_id);
          hideLoginModal();
          document.getElementById('comment-form').style.display = '';
          document.getElementById('quiz-section').style.display = '';
        } else {
          document.getElementById('login-error').textContent = data.error || 'Erreur de connexion';
        }
      });
    });

    // Déconnexion
    document.getElementById('logout-btn').onclick = function() {
      fetch('logout.php', { method: 'POST' })
        .then(() => {
          localStorage.removeItem('user_id');
          localStorage.removeItem('prenom');
          location.reload();
        });
    };

    // Charger et afficher le nombre de likes et l'état du bouton
    function updateLikeStatus() {
      fetch('get_likes.php')
        .then(res => res.json())
        .then(data => {
          document.getElementById('like-count').textContent = data.count || 0;
          const btn = document.getElementById('like-btn');
          if (data.has_liked) {
            btn.disabled = true;
            btn.textContent = '❤️ Déjà aimé (' + data.count + ')';
            btn.classList.add('liked');
          } else {
            btn.disabled = false;
            btn.textContent = '❤️ J\'aime (' + data.count + ')';
            btn.classList.remove('liked');
          }
        });
    }

    updateLikeStatus();

    document.getElementById('like-btn').addEventListener('click', function() {
      fetch('like.php', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          updateLikeStatus();
        });
    });

    // Quand l'utilisateur se connecte ou se déconnecte, on met à jour le bouton like
    function onLoginStateChange() {
      updateLikeStatus();
    }
    // Appelle onLoginStateChange après login/logout
    document.getElementById('login-form').addEventListener('submit', function(e){
      e.preventDefault();
      const prenom = document.getElementById('login-prenom').value.trim();
      const numero = document.getElementById('login-numero').value.trim();
      fetch('login.php', {
        method: 'POST',
        body: new URLSearchParams({prenom, numero})
      })
      .then(res => res.json())
      .then(data => {
        if(data.success){
          localStorage.setItem('prenom', data.prenom);
          localStorage.setItem('user_id', data.user_id);
          hideLoginModal();
          document.getElementById('comment-form').style.display = '';
          document.getElementById('quiz-section').style.display = '';
          onLoginStateChange();
        } else {
          document.getElementById('login-error').textContent = data.error || 'Erreur de connexion';
        }
      });
    });
    document.getElementById('logout-btn').onclick = function() {
      localStorage.removeItem('user_id');
      localStorage.removeItem('prenom');
      location.reload();
      onLoginStateChange();
    };

    // Newsletter (abonnement)
    document.getElementById('newsletter-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const email = document.getElementById('newsletter-email').value;
      if(email) {
        const formData = new FormData();
        formData.append('email', email);
        fetch('newsletter.php', {
          method: 'POST',
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          if(data.success) {
            document.getElementById('newsletter-success').textContent = 'Merci pour votre abonnement !';
            document.getElementById('newsletter-success').classList.add('visible');
            document.getElementById('newsletter-form').reset();
            setTimeout(() => {
              document.getElementById('newsletter-success').classList.remove('visible');
            }, 3500);
          } else {
            alert('Erreur : ' + (data.error || 'Impossible de s\'abonner.'));
          }
        });
      }
    });

    // Contact auteur
    document.getElementById('contact-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const nom = document.getElementById('contact-nom').value;
      const email = document.getElementById('contact-email').value;
      const message = document.getElementById('contact-message').value;
      if(nom && email && message) {
        const formData = new FormData();
        formData.append('nom', nom);
        formData.append('email', email);
        formData.append('message', message);
        fetch('contact.php', {
          method: 'POST',
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          if(data.success) {
            document.getElementById('contact-success').textContent = 'Votre message a bien été envoyé !';
            document.getElementById('contact-success').classList.add('visible');
            document.getElementById('contact-form').reset();
            setTimeout(() => {
              document.getElementById('contact-success').classList.remove('visible');
            }, 3500);
          } else {
            alert('Erreur : ' + (data.error || 'Impossible d\'envoyer le message.'));
          }
        });
      }
    });

    // === QUIZ INTERACTIF PAR ETAPES DE 5 QUESTIONS ===
    async function loadQuiz() {
      const response = await fetch('recueil.json');
      const data = await response.json();
      let quiz = data.quiz || (Array.isArray(data) && data[0].quiz);
      if (!quiz) {
        document.getElementById('quiz-container').innerHTML = '<em>Quiz non disponible.</em>';
        return;
      }
      // Filtrer les questions open sauf celles qui demandent le nom
      quiz = quiz.filter(q => q.type !== 'open' || (q.question && q.question.toLowerCase().includes('nom')));
      let allQuestions = [...quiz];
      let currentStep = 0;
      let questionsPerStep = 5;
      let currentQuestions = [];
      let current = 0;
      let score = 0;
      let totalSteps = Math.ceil(allQuestions.length / questionsPerStep);
      // Sons
      let winSound = new Audio('https://cdn.pixabay.com/audio/2022/07/26/audio_124bfa4c7b.mp3'); // son victoire
      let failSound = new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_115b9b7bfa.mp3'); // son echec
      // Canvas feu d'artifice
      function showFireworks() {
        let fw = document.createElement('canvas');
        fw.id = 'fireworks-canvas';
        fw.width = 400; fw.height = 200;
        fw.style.display = 'block';
        fw.style.margin = '20px auto';
        fw.style.background = 'transparent';
        document.getElementById('quiz-container').appendChild(fw);
        let ctx = fw.getContext('2d');
        let particles = [];
        for(let i=0;i<60;i++){
          let angle = Math.random()*2*Math.PI;
          let speed = 2+Math.random()*2;
          particles.push({
            x:200,y:100,
            vx:Math.cos(angle)*speed,
            vy:Math.sin(angle)*speed,
            color:`hsl(${Math.random()*360},100%,60%)`,
            life:40+Math.random()*20
          });
        }
        let frame=0;
        function animate(){
          ctx.clearRect(0,0,400,200);
          for(let p of particles){
            ctx.beginPath();
            ctx.arc(p.x,p.y,3,0,2*Math.PI);
            ctx.fillStyle=p.color;
            ctx.fill();
            p.x+=p.vx; p.y+=p.vy; p.vy+=0.04;
            p.life--;
          }
          particles = particles.filter(p=>p.life>0);
          if(particles.length>0 && frame<60) requestAnimationFrame(animate);
        }
        animate();
      }
      function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }
      function startStep() {
        score = 0;
        current = 0;
        // Mélanger et prendre 5 questions
        currentQuestions = shuffle([...allQuestions]).slice(0, questionsPerStep);
        showQuestion();
      }
      function updateProgressBar() {
        const percent = Math.round(((current) / questionsPerStep) * 100);
        document.getElementById('quiz-progress-inner').style.width = percent + '%';
      }
      function showQuestion() {
        updateProgressBar();
        const q = currentQuestions[current];
        let html = `<h3>Question ${current + 1} : ${q.question}</h3>`;
        if (q.type === 'qcm') {
          q.reponses_possibles.forEach((rep, i) => {
            html += `<label style='display:block;margin-bottom:6px;'><input type="radio" name="rep" value="${rep}"> ${rep}</label>`;
          });
        } else if (q.type === 'vrai_faux') {
          if (typeof q.reponse_correcte === "boolean") {
            html += `<label style='display:block;margin-bottom:6px;'><input type="radio" name="rep" value="true"> Vrai</label>`;
            html += `<label style='display:block;margin-bottom:6px;'><input type="radio" name="rep" value="false"> Faux</label>`;
          } else {
            html += `<label style='display:block;margin-bottom:6px;'><input type="radio" name="rep" value="${q.reponse_correcte}"> ${q.reponse_correcte}</label>`;
          }
        } else if (q.type === 'open') {
          html += `<input type="text" name="rep" id="repOpen" style='width:80%;margin-bottom:10px;'><br>`;
        }
        html += `<button class='btn btn-primary' onclick="submitAnswer()">Valider</button>`;
        document.getElementById('quiz-container').innerHTML = html;
      }
      window.submitAnswer = function() {
        const q = currentQuestions[current];
        let userAnswer;
        if (q.type === 'qcm' || q.type === 'vrai_faux') {
          const checked = document.querySelector('input[name="rep"]:checked');
          if (!checked) { alert("Choisissez une réponse"); return; }
          userAnswer = checked.value;
          if (typeof q.reponse_correcte === "boolean") {
            userAnswer = (userAnswer === "true");
          }
        } else if (q.type === 'open') {
          userAnswer = document.getElementById('repOpen').value.trim();
        }
        let correct = false;
        if (q.type === 'open') {
          correct = userAnswer.length > 0; // juste vérifier que le nom est saisi
        } else {
          correct = userAnswer == q.reponse_correcte;
        }
        if (correct) score++;
        let feedback = correct ? "<span style='color:#27ae60;font-weight:bold;'>Bonne réponse !</span>" : "<span style='color:#e74c3c;font-weight:bold;'>Mauvaise réponse.</span>";
        if (q.explication) feedback += `<br><em>${q.explication}</em>`;
        feedback += `<br><button class='btn btn-secondary' onclick="nextQuestion()">Suivant</button>`;
        document.getElementById('quiz-container').innerHTML = feedback;
      };
      window.nextQuestion = function() {
        current++;
        if (current < currentQuestions.length) {
          showQuestion();
        } else {
          updateProgressBar();
          // Fin de l'étape
          if (score >= 3) {
            winSound.play();
            document.getElementById('quiz-container').innerHTML = `<h2>Bravo !</h2><p>Score : <strong>${score} / ${questionsPerStep}</strong></p><button class='btn btn-primary' onclick='nextStep()'>Étape suivante</button>`;
            showFireworks();
          } else {
            failSound.play();
            document.getElementById('quiz-container').innerHTML = `<h2>Échec</h2><p>Score : <strong>${score} / ${questionsPerStep}</strong></p><button class='btn btn-primary' onclick='retryStep()'>Rejouer cette étape</button>`;
          }
        }
      };
      window.nextStep = function() {
        // On peut continuer si on a encore assez de questions
        if (allQuestions.length >= questionsPerStep) {
          startStep();
        } else {
          document.getElementById('quiz-container').innerHTML = `<h2>Quiz terminé !</h2><p>Félicitations, vous avez terminé toutes les étapes !</p>`;
          showFireworks();
        }
        updateProgressBar();
      };
      window.retryStep = function() {
        startStep();
        updateProgressBar();
      };
      startStep();
      updateProgressBar();
    }
    loadQuiz();
  </script>
</body>
</html>
